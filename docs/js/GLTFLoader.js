import{a as e,b as t,S as s}from"../main.js";import{TextureLoader as n,MeshBasicMaterial as o,BackSide as r,BoxGeometry as a,Mesh as i,Loader as l,LoaderUtils as c,FileLoader as u,Color as p,SpotLight as d,PointLight as h,DirectionalLight as m,MeshStandardMaterial as f,TangentSpaceNormalMap as g,ImageBitmapLoader as T,InterleavedBuffer as y,BufferAttribute as v,LinearFilter as S,LinearMipmapLinearFilter as x,RepeatWrapping as R,RGBFormat as w,PointsMaterial as _,Material as b,LineBasicMaterial as E,DoubleSide as A,Vector2 as L,sRGBEncoding as I,BufferGeometry as O,SkinnedMesh as P,LineSegments as C,Line as H,LineLoop as N,Points as U,Group as F,PerspectiveCamera as D,Math as G,OrthographicCamera as k,InterpolateLinear as j,AnimationClip as K,Bone as B,Object3D as V,PropertyBinding as X,Matrix4 as z,Skeleton as $,MeshPhysicalMaterial as W,Interpolant as q,NearestFilter as Y,NearestMipmapNearestFilter as Z,LinearMipmapNearestFilter as J,NearestMipmapLinearFilter as Q,ClampToEdgeWrapping as ee,MirroredRepeatWrapping as te,InterpolateDiscrete as se,RGBAFormat as ne,FrontSide as oe,InterleavedBufferAttribute as re,CanvasTexture as ae,TriangleFanDrawMode as ie,TriangleStripDrawMode as le,VectorKeyframeTrack as ce,QuaternionKeyframeTrack as ue,NumberKeyframeTrack as pe,Box3 as de,Vector3 as he,Sphere as me}from"./three.module.js";const fe=({data:s,scene:l})=>{const c=s.skybox||"default",u=`${t}/${c}`,p=new n,d=[new o({map:p.load(u+"/px.jpg"),side:r}),new o({map:p.load(u+"/nx.jpg"),side:r}),new o({map:p.load(u+"/py.jpg"),side:r}),new o({map:p.load(u+"/ny.jpg"),side:r}),new o({map:p.load(u+"/pz.jpg"),side:r}),new o({map:p.load(u+"/nz.jpg"),side:r})],h=new a(...e),m=new i(h,d);return m.visible=!1,l.add(m),m},ge=({camera:e,controller:t,model:n,reticle:o,scene:r,type:a})=>()=>{if(XR){if(a===s.HIT)o.visible&&(n.position.setFromMatrixPosition(o.matrix),r.add(n));else if(a===s.FLOAT){const e=n.clone();e.position.set(0,0,-1).applyMatrix4(t.matrixWorld),e.quaternion.setFromRotationMatrix(t.matrixWorld),r.add(e)}}else e.position.set(0,0,5),t&&t.update(),r.add(n)},Te=function(){function e(e){l.call(this,e),this.dracoLoader=null,this.ddsLoader=null,this.pluginCallbacks=[],this.register((function(e){return new ge(e)}))}function t(){let e={};return{get:t=>e[t],add(t,s){e[t]=s},remove(t){delete e[t]},removeAll(){e={}}}}e.prototype=Object.assign(Object.create(l.prototype),{constructor:e,load:function(e,t,s,n){const o=this;let r;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:c.extractUrlBase(e),o.manager.itemStart(e);const a=t=>{n?n(t):console.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},i=new u(o.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),"use-credentials"===o.crossOrigin&&i.setWithCredentials(!0),i.load(e,(function(s){try{o.parse(s,r,(function(s){t(s),o.manager.itemEnd(e)}),a)}catch(e){a(e)}}),s,a)},setDRACOLoader(e){return this.dracoLoader=e,this},setDDSLoader(e){return this.ddsLoader=e,this},register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse(e,t,n,o){let i;const l={},u={};if(IS.str(e))i=e;else{if(c.decodeText(new Uint8Array(e,0,4))===Te){try{l[s.KHR_BINARY_GLTF]=new Se(e)}catch(e){return void(o&&o(e))}i=l[s.KHR_BINARY_GLTF].content}else i=c.decodeText(new Uint8Array(e))}const p=JSON.parse(i);if(void 0===p.asset||p.asset.version[0]<2)return void(o&&o(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const d=new Ye(p,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager});d.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](d);u[t.name]=t,l[t.name]=!0}if(p.extensionsUsed)for(let e=0;e<p.extensionsUsed.length;++e){const t=p.extensionsUsed[e],n=p.extensionsRequired||[];switch(t){case s.KHR_LIGHTS_PUNCTUAL:l[t]=new a(p);break;case s.KHR_MATERIALS_UNLIT:l[t]=new fe;break;case s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:l[t]=new we;break;case s.KHR_DRACO_MESH_COMPRESSION:l[t]=new Me(p,this.dracoLoader);break;case s.MSFT_TEXTURE_DDS:l[t]=new r(this.ddsLoader);break;case s.KHR_TEXTURE_TRANSFORM:l[t]=new xe;break;case s.KHR_MESH_QUANTIZATION:l[t]=new _e;break;default:n.indexOf(t)>=0&&void 0===u[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}d.setExtensions(l),d.setPlugins(u),d.parse(n,o)}});const s={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function r(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=s.MSFT_TEXTURE_DDS,this.ddsLoader=e}function a(e){this.name=s.KHR_LIGHTS_PUNCTUAL;const t=e.extensions&&e.extensions[s.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function fe(){this.name=s.KHR_MATERIALS_UNLIT}function ge(e){this.parser=e,this.name=s.KHR_MATERIALS_CLEARCOAT}a.prototype.loadLight=function(e){const t=this.lightDefs[e];let s;const n=new p(16777215);void 0!==t.color&&n.fromArray(t.color);const o=void 0!==t.range?t.range:0;switch(t.type){case"directional":s=new m(n),s.target.position.set(0,0,-1),s.add(s.target);break;case"point":s=new h(n),s.distance=o;break;case"spot":s=new d(n),s.distance=o,t.spot=t.spot||{},t.spot.innerConeAngle=void 0!==t.spot.innerConeAngle?t.spot.innerConeAngle:0,t.spot.outerConeAngle=void 0!==t.spot.outerConeAngle?t.spot.outerConeAngle:M.PI/4,s.angle=t.spot.outerConeAngle,s.penumbra=1-t.spot.innerConeAngle/t.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+t.type+'".')}return s.position.set(0,0,0),s.decay=2,void 0!==t.intensity&&(s.intensity=t.intensity),s.name=t.name||"light_"+e,Promise.resolve(s)},fe.prototype.getMaterialType=function(){return o},fe.prototype.extendParams=function(e,t,s){const n=[];e.color=new p(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const t=o.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==o.baseColorTexture&&n.push(s.assignTexture(e,"map",o.baseColorTexture))}return Promise.all(n)},ge.prototype.getMaterialType=function(){return W},ge.prototype.extendMaterialParams=function(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&o.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&o.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(o.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new L(e,e)}return Promise.all(o)};const Te="glTF",ye=1313821514,ve=5130562;function Se(e){this.name=s.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:c.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Te)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=new DataView(e,12);let o=0;for(;o<n.byteLength;){const t=n.getUint32(o,!0);o+=4;const s=n.getUint32(o,!0);if(o+=4,s===ye){const s=new Uint8Array(e,12+o,t);this.content=c.decodeText(s)}else if(s===ve){const s=12+o;this.body=e.slice(s,s+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function Me(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=s.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function xe(){this.name=s.KHR_TEXTURE_TRANSFORM}function Re(e){f.call(this),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),a={specular:{value:(new p).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(let t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","uniform float glossiness;"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_pars_fragment>",t),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_pars_fragment>",s),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>",n),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_fragment>",o),e.fragmentShader=e.fragmentShader.replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_ROUGHNESSMAP=""):(delete this.defines.USE_ROUGHNESSMAP,delete this.defines.USE_GLOSSINESSMAP)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function we(){return{name:s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return Re},extendParams:function(e,t,s){const n=t.extensions[this.name];e.color=new p(1,1,1),e.opacity=1;const o=[];if(Array.isArray(n.diffuseFactor)){const t=n.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==n.diffuseTexture&&o.push(s.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new p(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new p(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){const t=n.specularGlossinessTexture;o.push(s.assignTexture(e,"glossinessMap",t)),o.push(s.assignTexture(e,"specularMap",t))}return Promise.all(o)},createMaterial:function(e){const t=new Re(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=g,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function _e(){this.name=s.KHR_MESH_QUANTIZATION}function be(e,t,s,n){q.call(this,e,t,s,n)}Me.prototype.decodePrimitive=function(e,t){const s=this.json,n=this.dracoLoader,o=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,a={},i={},l={};for(let e in r){const t=De[e]||e.toLowerCase();a[t]=r[e]}for(attributeName in e.attributes){const t=De[attributeName]||attributeName.toLowerCase();if(void 0!==r[attributeName]){const n=s.accessors[e.attributes[attributeName]],o=He[n.componentType];l[t]=o,i[t]=!0===n.normalized}}return t.getDependency("bufferView",o).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(let t in e.attributes){const s=e.attributes[t],n=i[t];void 0!==n&&(s.normalized=n)}t(e)}),a,l)}))}))},xe.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},Re.prototype=Object.create(f.prototype),Re.prototype.constructor=Re,Re.prototype.copy=function(e){return f.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},be.prototype=Object.create(q.prototype),be.prototype.constructor=be,be.prototype.copySampleValue_=function(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,o=e*n*3+n;for(let e=0;e!==n;e++)t[e]=s[o+e];return t},be.prototype.beforeStart_=be.prototype.copySampleValue_,be.prototype.afterEnd_=be.prototype.copySampleValue_,be.prototype.interpolate_=function(e,t,s,n){const o=this.resultBuffer,r=this.sampleValues,a=this.valueSize,i=2*a,l=3*a,c=n-t,u=(s-t)/c,p=u*u,d=p*u,h=e*l,m=h-l,f=-2*d+3*p,g=d-p,T=1-f,y=g-p+u;for(let e=0;e!==a;e++){const t=r[m+e+a],s=r[m+e+i]*c,n=r[h+e+a],l=r[h+e]*c;o[e]=T*t+y*s+f*n+g*l}return o};const Ee=0,Ae=1,Le=2,Ie=3,Oe=4,Pe=5,Ce=6,He={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ne={9728:Y,9729:S,9984:Z,9985:J,9986:Q,9987:x},Ue={33071:ee,33648:te,10497:R},Fe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},De={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ge={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ke={CUBICSPLINE:void 0,LINEAR:j,STEP:se},je="OPAQUE",Ke="MASK",Be="BLEND",Ve={"image/png":ne,"image/jpeg":w};function Xe(e,t){return IS.not(e,"string")||IS.empty(e)?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function ze(e,t,s){for(let n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function $e(e,t){void 0!==t.extras&&(IS.obj(t.extras)?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function We(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function qe(e){const t=e.extensions&&e.extensions[s.KHR_DRACO_MESH_COMPRESSION];if(t){const{bufferView:e,indices:s,attributes:n}=t;return`draco:${e}:${s}:${n}`}{const{indices:t,attributes:s,mode:n}=e;return`${t}:${function(e){let t="";const s=Object.keys(e).sort();for(let n=0,o=s.length;n<o;n++)t+=s[n]+":"+e[s[n]]+";";return t}(s)}:${n}`}}function Ye(e,s){this.json=e||{},this.extensions={},this.plugins={},this.options=s||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},IS.not(createImageBitmap,"undefined")||!1!==/Firefox/.test(navigator.userAgent)?this.textureLoader=new n(this.options.manager):this.textureLoader=new T(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new u(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function Ze(e,t,s){const n=t.attributes,o=[],r=(t,n)=>s.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}));for(let t in n){const s=De[t]||t.toLowerCase();s in e.attributes||o.push(r(n[t],s))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));o.push(n)}return $e(e,t),function(e,t,s){const n=t.attributes,o=new de;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],{max:t,min:r}=e;if(void 0===r||void 0===t)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");o.set(new he(r[0],r[1],r[2]),new he(t[0],t[1],t[2]))}const r=t.targets;if(void 0!==r){const e=new he,t=new he;for(let n=0,o=r.length;n<o;n++){const o=r[n];if(void 0!==o.POSITION){const n=s.json.accessors[o.POSITION],{max:r,min:a}=n;void 0!==a&&void 0!==r?(t.setX(M.max(M.abs(a[0]),M.abs(r[0]))),t.setY(M.max(M.abs(a[1]),M.abs(r[1]))),t.setZ(M.max(M.abs(a[2]),M.abs(r[2]))),e.max(t)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;const a=new me;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,s),Promise.all(o).then(()=>void 0!==t.targets?function(e,t,s){let n=!1,o=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(n=!0),void 0!==s.NORMAL&&(o=!0),n&&o)break}if(!n&&!o)return Promise.resolve(e);const r=[],a=[];for(let i=0,l=t.length;i<l;i++){const l=t[i];if(n){const t=void 0!==l.POSITION?s.getDependency("accessor",l.POSITION):e.attributes.position;r.push(t)}if(o){const t=void 0!==l.NORMAL?s.getDependency("accessor",l.NORMAL):e.attributes.normal;a.push(t)}}return Promise.all([Promise.all(r),Promise.all(a)]).then((function(t){const s=t[0],r=t[1];return n&&(e.morphAttributes.position=s),o&&(e.morphAttributes.normal=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e)}function Je(e,t){const s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,o=[];if(t===ie)for(let e=1;e<=n;e++)o.push(s.getX(0)),o.push(s.getX(e)),o.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(o.push(s.getX(e)),o.push(s.getX(e+1)),o.push(s.getX(e+2))):(o.push(s.getX(e+2)),o.push(s.getX(e+1)),o.push(s.getX(e)));o.length/3!==n&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=e.clone();return r.setIndex(o),r}return Ye.prototype.setExtensions=function(e){this.extensions=e},Ye.prototype.setPlugins=function(e){this.plugins=e},Ye.prototype.parse=function(e,t){const s=this,{extensions:n,json:o}=this;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(t){const r={scene:t[0][o.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:o.asset,parser:s,userData:{}};ze(n,r,o),$e(r,o),e(r)})).catch(t)},Ye.prototype.markDefs=function(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[],n={},o={};for(let s=0,n=t.length;s<n;s++){const n=t[s].joints;for(let t=0,s=n.length;t<s;t++)e[n[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){const r=e[t];void 0!==r.mesh&&(void 0===n[r.mesh]&&(n[r.mesh]=o[r.mesh]=0),n[r.mesh]++,void 0!==r.skin&&(s[r.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=o},Ye.prototype._invokeOne=function(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}},Ye.prototype._invokeAll=function(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++)s.push(e(t[n]));return Promise.all(s)},Ye.prototype.getDependency=function(e,t){const n=e+":"+t;let o=this.cache.get(n);if(!o){switch(e){case"scene":o=this.loadScene(t);break;case"node":o=this.loadNode(t);break;case"mesh":o=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":o=this.loadAccessor(t);break;case"bufferView":o=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":o=this.loadBuffer(t);break;case"material":o=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":o=this.loadTexture(t);break;case"skin":o=this.loadSkin(t);break;case"animation":o=this.loadAnimation(t);break;case"camera":o=this.loadCamera(t);break;case"light":o=this.extensions[s.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(n,o)}return o},Ye.prototype.getDependencies=function(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((t,n)=>s.getDependency(e,n))),this.cache.add(e,t)}return t},Ye.prototype.loadBuffer=function(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[s.KHR_BINARY_GLTF].body);const o=this.options;return new Promise((function(e,s){n.load(Xe(t.uri,o.path),e,void 0,(function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},Ye.prototype.loadBufferView=function(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const{byteLength:s=0,byteOffset:n=0}=t;return e.slice(n,n+s)}))},Ye.prototype.loadAccessor=function(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);const o=[];return void 0!==n.bufferView?o.push(this.getDependency("bufferView",n.bufferView)):o.push(null),void 0!==n.sparse&&(o.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(o).then((function(e){const o=e[0],r=Fe[n.type],a=He[n.componentType],i=a.BYTES_PER_ELEMENT,l=i*r,c=n.byteOffset||0,u=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,p=!0===n.normalized;let d,h;if(u&&u!==l){const e=M.floor(c/u),{bufferView:s,componentType:o,count:l}=n,m=`InterleavedBuffer:${s}:${o}:${e}:${l}`,f=t.cache.get(m);f||(d=new a(s,e*u,n.count*u/i),f=new y(d,u/i),t.cache.add(m,f)),h=new re(f,r,c%u/i,p)}else d=null===o?new a(n.count*r):new a(o,c,n.count*r),h=new v(d,r,p);if(void 0!==n.sparse){const t=Fe.SCALAR,s=He[n.sparse.indices.componentType],i=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,c=new s(e[1],i,n.sparse.count*t),u=new a(e[2],l,n.sparse.count*r);null!==o&&(h=new v(h.array.slice(),h.itemSize,h.normalized));for(let e=0,t=c.length;e<t;e++){const t=c[e];if(h.setX(t,u[e*r]),r>=2&&h.setY(t,u[e*r+1]),r>=3&&h.setZ(t,u[e*r+2]),r>=4&&h.setW(t,u[e*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return h}))},Ye.prototype.loadTexture=function(e){const t=this,{json:n,options:o,textureLoader:r}=this,a=self.URL||self.webkitURL,i=n.textures[e],l=i.extensions||{};let c;c=l[s.MSFT_TEXTURE_DDS]?n.images[l[s.MSFT_TEXTURE_DDS].source]:n.images[i.source];let u=c.uri,p=!1;return void 0!==c.bufferView&&(u=t.getDependency("bufferView",c.bufferView).then((function(e){p=!0;const t=new Blob([e],{type:c.mimeType});return u=a.createObjectURL(t),u}))),Promise.resolve(u).then((function(e){let n=o.manager.getHandler(e);return n||(n=l[s.MSFT_TEXTURE_DDS]?t.extensions[s.MSFT_TEXTURE_DDS].ddsLoader:r),new Promise((function(t,s){let r=t;!0===n.isImageBitmapLoader&&(r=e=>t(new ae(e))),n.load(Xe(e,o.path),r,void 0,s)}))})).then((function(s){!0===p&&a.revokeObjectURL(u),s.flipY=!1,i.name&&(s.name=i.name),c.mimeType in Ve&&(s.format=Ve[c.mimeType]);const o=(n.samplers||{})[i.sampler]||{};return s.magFilter=Ne[o.magFilter]||S,s.minFilter=Ne[o.minFilter]||x,s.wrapS=Ue[o.wrapS]||R,s.wrapT=Ue[o.wrapT]||R,t.associations.set(s,{type:"textures",index:e}),s}))},Ye.prototype.assignTexture=function(e,t,n){const o=this;return this.getDependency("texture",n.index).then((function(r){if(!r.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":r.format=w}if(void 0===n.texCoord||0==n.texCoord||"aoMap"===t&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),o.extensions[s.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[s.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=o.associations.get(r);r=o.extensions[s.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),o.associations.set(r,t)}}e[t]=r}))},Ye.prototype.assignFinalMaterial=function(e){const t=e.geometry;let s=e.material;const n=void 0!==t.attributes.tangent,o=void 0!==t.attributes.color,r=void 0===t.attributes.normal,a=!0===e.isSkinnedMesh,i=Object.keys(t.morphAttributes).length>0,l=i&&void 0!==t.morphAttributes.normal;if(e.isPoints){let e="PointsMaterial:"+s.uuid;const t=this.cache.get(e);t||(t=new _,b.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid,t=this.cache.get(e);t||(t=new E,b.prototype.copy.call(t,s),t.color.copy(s.color),this.cache.add(e,t)),s=t}if(n||o||r||a||i){let e="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),a&&(e+="skinning:"),n&&(e+="vertex-tangents:"),o&&(e+="vertex-colors:"),r&&(e+="flat-shading:"),i&&(e+="morph-targets:"),l&&(e+="morph-normals:");let t=this.cache.get(e);t||(t=s.clone(),a&&(t.skinning=!0),n&&(t.vertexTangents=!0),o&&(t.vertexColors=!0),r&&(t.flatShading=!0),i&&(t.morphTargets=!0),l&&(t.morphNormals=!0),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),s.normalScale&&!n&&(s.normalScale.y=-s.normalScale.y),s.clearcoatNormalScale&&!n&&(s.clearcoatNormalScale.y=-s.clearcoatNormalScale.y),e.material=s},Ye.prototype.getMaterialType=function(){return f},Ye.prototype.loadMaterial=function(e){const t=this,{extensions:n,json:r}=this,a=r.materials[e];let i;const l={},c=a.extensions||{},u=[];if(c[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=n[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];i=e.getMaterialType(),u.push(e.extendParams(l,a,t))}else if(c[s.KHR_MATERIALS_UNLIT]){const e=n[s.KHR_MATERIALS_UNLIT];i=e.getMaterialType(),u.push(e.extendParams(l,a,t))}else{const s=a.pbrMetallicRoughness||{};if(l.color=new p(1,1,1),l.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;l.color.fromArray(e),l.opacity=e[3]}void 0!==s.baseColorTexture&&u.push(t.assignTexture(l,"map",s.baseColorTexture)),l.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,l.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(u.push(t.assignTexture(l,"metalnessMap",s.metallicRoughnessTexture)),u.push(t.assignTexture(l,"roughnessMap",s.metallicRoughnessTexture))),i=this._invokeOne(t=>t.getMaterialType&&t.getMaterialType(e)),u.push(this._invokeAll(t=>t.extendMaterialParams&&t.extendMaterialParams(e,l)))}!0===a.doubleSided&&(l.side=A);const d=a.alphaMode||je;return d===Be?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,d===Ke&&(l.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&i!==o&&(u.push(t.assignTexture(l,"normalMap",a.normalTexture)),l.normalScale=new L(1,1),void 0!==a.normalTexture.scale&&l.normalScale.set(a.normalTexture.scale,a.normalTexture.scale)),void 0!==a.occlusionTexture&&i!==o&&(u.push(t.assignTexture(l,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(l.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&i!==o&&(l.emissive=(new p).fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&i!==o&&u.push(t.assignTexture(l,"emissiveMap",a.emissiveTexture)),Promise.all(u).then((function(){let o;return o=i===Re?n[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(l):new i(l),a.name&&(o.name=a.name),o.map&&(o.map.encoding=I),o.emissiveMap&&(o.emissiveMap.encoding=I),$e(o,a),t.associations.set(o,{type:"materials",index:e}),a.extensions&&ze(n,o,a),o}))},Ye.prototype.loadGeometries=function(e){const t=this,n=this.extensions,o=this.primitiveCache,r=e=>n[s.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(s=>Ze(s,e,t)),a=[];for(let n=0,i=e.length;n<i;n++){const i=e[n],l=qe(i),c=o[l];if(c)a.push(c.promise);else{let e;e=i.extensions&&i.extensions[s.KHR_DRACO_MESH_COMPRESSION]?r(i):Ze(new O,i,t),o[l]={primitive:i,promise:e},a.push(e)}}return Promise.all(a)},Ye.prototype.loadMesh=function(e){const t=this,{json:s}=this,n=s.meshes[e],o=n.primitives,r=[];for(let e=0,t=o.length;e<t;e++){const t=void 0===o[e].material?(void 0===(a=this.cache).DefaultMaterial&&(a.DefaultMaterial=new f({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:oe})),a.DefaultMaterial):this.getDependency("material",o[e].material);r.push(t)}var a;return r.push(t.loadGeometries(o)),Promise.all(r).then((function(s){const r=s.slice(0,s.length-1),a=s[s.length-1],l=[];for(let s=0,c=a.length;s<c;s++){const c=a[s],u=o[s];let p;const d=r[s];if(u.mode===Oe||u.mode===Pe||u.mode===Ce||void 0===u.mode)p=!0===n.isSkinnedMesh?new P(c,d):new i(c,d),!0!==p.isSkinnedMesh||p.geometry.attributes.skinWeight.normalized||p.normalizeSkinWeights(),u.mode===Pe?p.geometry=Je(p.geometry,le):u.mode===Ce&&(p.geometry=Je(p.geometry,ie));else if(u.mode===Ae)p=new C(c,d);else if(u.mode===Ie)p=new H(c,d);else if(u.mode===Le)p=new N(c,d);else{if(u.mode!==Ee)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);p=new U(c,d)}Object.keys(p.geometry.morphAttributes).length>0&&We(p,n),p.name=n.name||"mesh_"+e,a.length>1&&(p.name+="_"+s),$e(p,n),t.assignFinalMaterial(p),l.push(p)}if(1===l.length)return l[0];const c=new F;for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c}))},Ye.prototype.loadCamera=function(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new D(G.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new k(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=s.name),$e(t,s),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},Ye.prototype.loadSkin=function(e){const t=this.json.skins[e],s={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return s.inverseBindMatrices=e,s}))},Ye.prototype.loadAnimation=function(e){const t=this.json.animations[e],s=[],n=[],o=[],r=[],a=[];for(let e=0,i=t.channels.length;e<i;e++){const i=t.channels[e],l=t.samplers[i.sampler],c=i.target,u=void 0!==c.node?c.node:c.id,p=void 0!==t.parameters?t.parameters[l.input]:l.input,d=void 0!==t.parameters?t.parameters[l.output]:l.output;s.push(this.getDependency("node",u)),n.push(this.getDependency("accessor",p)),o.push(this.getDependency("accessor",d)),r.push(l),a.push(c)}return Promise.all([Promise.all(s),Promise.all(n),Promise.all(o),Promise.all(r),Promise.all(a)]).then((function(s){const n=s[0],o=s[1],r=s[2],a=s[3],i=s[4],l=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],s=o[e],c=r[e],u=a[e],p=i[e];if(void 0===t)continue;let d;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,Ge[p.path]){case Ge.weights:d=pe;break;case Ge.rotation:d=ue;break;case Ge.position:case Ge.scale:default:d=ce}const h=t.name?t.name:t.uuid,m=void 0!==u.interpolation?ke[u.interpolation]:j,f=[];Ge[p.path]===Ge.weights?t.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&f.push(e.name?e.name:e.uuid)})):f.push(h);const g=c.array;if(c.normalized){let e;if(g.constructor===Int8Array)e=1/127;else if(g.constructor===Uint8Array)e=1/255;else if(g.constructor==Int16Array)e=1/32767;else{if(g.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");e=1/65535}const t=new Float32Array(g.length);for(let s=0,n=g.length;s<n;s++)t[s]=g[s]*e;g=t}for(let e=0,t=f.length;e<t;e++){const t=new d(f[e]+"."+Ge[p.path],s.array,g,m);"CUBICSPLINE"===u.interpolation&&(t.createInterpolant=function(e){return new be(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(t)}}const c=t.name?t.name:"animation_"+e;return new K(c,void 0,l)}))},Ye.prototype.loadNode=function(e){const{extensions:t,json:n}=this,o=this,r=n.meshReferences,a=n.meshUses,i=n.nodes[e];return function(){const e=[];return void 0!==i.mesh&&e.push(o.getDependency("mesh",i.mesh).then((function(e){let t;if(r[i.mesh]>1){const s=a[i.mesh]++;t=e.clone(),t.name+="_instance_"+s}else t=e;return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))),void 0!==i.camera&&e.push(o.getDependency("camera",i.camera)),i.extensions&&i.extensions[s.KHR_LIGHTS_PUNCTUAL]&&void 0!==i.extensions[s.KHR_LIGHTS_PUNCTUAL].light&&e.push(o.getDependency("light",i.extensions[s.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(e)}().then((function(s){let n;if(n=!0===i.isBone?new B:s.length>1?new F:1===s.length?s[0]:new V,n!==s[0])for(let e=0,t=s.length;e<t;e++)n.add(s[e]);if(i.name&&(n.userData.name=i.name,n.name=X.sanitizeNodeName(i.name)),$e(n,i),i.extensions&&ze(t,n,i),void 0!==i.matrix){const e=new z;e.fromArray(i.matrix),n.applyMatrix4(e)}else void 0!==i.translation&&n.position.fromArray(i.translation),void 0!==i.rotation&&n.quaternion.fromArray(i.rotation),void 0!==i.scale&&n.scale.fromArray(i.scale);return o.associations.set(n,{type:"nodes",index:e}),n}))},Ye.prototype.loadScene=function(){function e(t,s,n,o){const r=n.nodes[t];return o.getDependency("node",t).then((function(e){if(void 0===r.skin)return e;let t;return o.getDependency("skin",r.skin).then((function(e){t=e;const s=[];for(let e=0,n=t.joints.length;e<n;e++)s.push(o.getDependency("node",t.joints[e]));return Promise.all(s)})).then((function(s){return e.traverse((function(e){if(!e.isMesh)return;const n=[],o=[];for(let e=0,r=s.length;e<r;e++){const r=s[e];if(r){n.push(r);const s=new z;void 0!==t.inverseBindMatrices&&s.fromArray(t.inverseBindMatrices.array,16*e),o.push(s)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}e.bind(new $(n,o),e.matrixWorld)})),e}))})).then((function(t){s.add(t);const a=[];if(r.children){const s=r.children;for(let r=0,i=s.length;r<i;r++){const i=s[r];a.push(e(i,t,n,o))}}return Promise.all(a)}))}return function(t){const{extensions:s,json:n}=this,o=n.scenes[t],r=this,a=new F;o.name&&(a.name=o.name),$e(a,o),o.extensions&&ze(s,a,o);const i=o.nodes||[],l=[];for(let t=0,s=i.length;t<s;t++)l.push(e(i[t],a,n,r));return Promise.all(l).then((function(){return a}))}}(),e}();export{Te as G,fe as a,ge as s};
